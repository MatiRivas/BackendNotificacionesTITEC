openapi: 3.0.3
info:
  title: TITEC - Microservicio de Notificaciones API
  description: |
    API del microservicio de notificaciones para TITEC - Sprint 3
    
    **Caracter√≠sticas principales:**
    - ‚úÖ Gesti√≥n completa de notificaciones
    - ‚úÖ M√∫ltiples canales (Email, SMS, Push)
    - ‚úÖ Estados progresivos autom√°ticos
    - ‚úÖ Change Streams para eventos en tiempo real
    - ‚úÖ Integraci√≥n con otros microservicios
    
    **Estados de notificaci√≥n:**
    - `pendiente`: Creada, esperando procesamiento
    - `enviado`: Enviada exitosamente
    - `recibido`: Recibida por el usuario
    - `leido`: Le√≠da por el usuario
    - `fallido`: Error en el env√≠o
    
  version: 3.0.0
  contact:
    name: Equipo TITEC
    email: equipo@titec.cl
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api/notifications
    description: Servidor de desarrollo local
  - url: https://api.titec.cl/notifications
    description: Servidor de producci√≥n

paths:
  # ===== GESTI√ìN DE NOTIFICACIONES =====
  /create:
    post:
      tags:
        - "üì® Gesti√≥n de Notificaciones"
      summary: Crear nueva notificaci√≥n
      description: |
        Crea una nueva notificaci√≥n en el sistema con los par√°metros especificados.
        La notificaci√≥n se crea en estado "pendiente" y puede ser procesada autom√°ticamente.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNotificationRequest'
            examples:
              orden_creada:
                summary: Notificaci√≥n de orden creada
                value:
                  id_emisor: 1
                  id_receptor: 123
                  id_plantilla: 1
                  channel_ids: [1, 3]
              pago_confirmado:
                summary: Notificaci√≥n de pago confirmado
                value:
                  id_emisor: 2
                  id_receptor: 456
                  id_plantilla: 6
                  channel_ids: [1]
      responses:
        '201':
          description: Notificaci√≥n creada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationResponse'
        '400':
          description: Datos de entrada inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor

  /test-create:
    post:
      tags:
        - "üì® Gesti√≥n de Notificaciones"
      summary: Crear notificaci√≥n de prueba
      description: |
        Crea una notificaci√≥n de prueba con estructura simplificada usando strings para emisor y receptor.
        √ötil para testing y desarrollo.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestCreateNotificationRequest'
            examples:
              test_order:
                summary: Notificaci√≥n de prueba
                value:
                  id_emisor: "orders-service"
                  id_receptor: "user-uuid-123"
                  id_plantilla: 1
                  channel_ids: [1, 3]
      responses:
        '201':
          description: Notificaci√≥n de prueba creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationResponse'

  /retry-failed:
    post:
      tags:
        - "üì® Gesti√≥n de Notificaciones"
      summary: Reintentar notificaciones fallidas
      description: |
        Reintenta enviar todas las notificaciones que tienen estado "fallido".
        √ötil para recuperaci√≥n autom√°tica de errores temporales.
      responses:
        '200':
          description: Reintento iniciado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Failed notifications retry initiated"

  # ===== CONSULTAS POR USUARIO =====
  /user/{userId}:
    get:
      tags:
        - "üë§ Consultas por Usuario"
      summary: Obtener notificaciones de usuario
      description: |
        Obtiene las notificaciones de un usuario espec√≠fico con paginaci√≥n.
        Soporta tanto IDs num√©ricos como UUIDs string.
      parameters:
        - name: userId
          in: path
          required: true
          description: ID del usuario (n√∫mero o UUID string)
          schema:
            oneOf:
              - type: integer
                example: 123
              - type: string
                example: "user-uuid-123"
        - name: page
          in: query
          description: N√∫mero de p√°gina
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          description: Elementos por p√°gina
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Lista de notificaciones del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserNotificationsResponse'
        '404':
          description: Usuario no encontrado

  /user-history/{userId}:
    get:
      tags:
        - "üë§ Consultas por Usuario"
      summary: Historial completo de notificaciones
      description: |
        Obtiene el historial completo de notificaciones de un usuario con metadatos adicionales.
      parameters:
        - name: userId
          in: path
          required: true
          description: ID del usuario (string UUID)
          schema:
            type: string
            example: "user-uuid-123"
        - name: page
          in: query
          description: N√∫mero de p√°gina
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Elementos por p√°gina
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Historial de notificaciones
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserHistoryResponse'

  # ===== ESTAD√çSTICAS =====
  /stats:
    get:
      tags:
        - "üìä Estad√≠sticas"
      summary: Estad√≠sticas b√°sicas del sistema
      description: |
        Obtiene estad√≠sticas generales del sistema de notificaciones incluyendo distribuci√≥n por estados y canales.
      responses:
        '200':
          description: Estad√≠sticas del sistema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'

  /history-stats:
    get:
      tags:
        - "üìä Estad√≠sticas"
      summary: Estad√≠sticas detalladas del historial
      description: |
        Obtiene estad√≠sticas detalladas del historial incluyendo uso de plantillas y distribuci√≥n temporal.
      responses:
        '200':
          description: Estad√≠sticas detalladas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryStatsResponse'

  # ===== CONFIGURACI√ìN =====
  /templates:
    get:
      tags:
        - "‚öôÔ∏è Configuraci√≥n"
      summary: Listar plantillas disponibles
      description: |
        Obtiene todas las plantillas de notificaci√≥n configuradas en el sistema.
      responses:
        '200':
          description: Lista de plantillas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Template'

  /channels:
    get:
      tags:
        - "‚öôÔ∏è Configuraci√≥n"
      summary: Listar canales disponibles
      description: |
        Obtiene todos los canales de notificaci√≥n configurados (Email, SMS, Push).
      responses:
        '200':
          description: Lista de canales
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Channel'

  /template-types:
    get:
      tags:
        - "‚öôÔ∏è Configuraci√≥n"
      summary: Listar tipos de plantillas
      description: |
        Obtiene todos los tipos de plantillas disponibles en el sistema.
      responses:
        '200':
          description: Lista de tipos de plantillas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TemplateType'

  # ===== MONITOREO =====
  /listener-status:
    get:
      tags:
        - "üéß Monitoreo"
      summary: Estado del sistema Change Streams
      description: |
        Obtiene el estado de los listeners de Change Streams y estad√≠sticas de integraci√≥n en tiempo real.
      responses:
        '200':
          description: Estado del sistema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListenerStatusResponse'

  # ===== TESTING =====
  /health/email:
    get:
      tags:
        - "üîß Testing"
      summary: Verificar estado del servicio de email
      description: |
        Verifica la conectividad y estado del servicio de email.
      responses:
        '200':
          description: Estado del servicio de email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /test/email:
    post:
      tags:
        - "üîß Testing"
      summary: Enviar email de prueba
      description: |
        Env√≠a un email de prueba al destinatario especificado para verificar el funcionamiento del servicio.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestEmailRequest'
      responses:
        '200':
          description: Resultado del env√≠o
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestEmailResponse'

components:
  schemas:
    # ===== REQUEST SCHEMAS =====
    CreateNotificationRequest:
      type: object
      required:
        - id_emisor
        - id_receptor
        - id_plantilla
        - channel_ids
      properties:
        id_emisor:
          type: integer
          description: ID del microservicio emisor
          example: 1
        id_receptor:
          type: integer
          description: ID del usuario receptor
          example: 123
        id_plantilla:
          type: integer
          description: ID de la plantilla a usar
          example: 1
        channel_ids:
          type: array
          items:
            type: integer
          description: IDs de los canales por los que enviar
          example: [1, 3]

    TestCreateNotificationRequest:
      type: object
      required:
        - id_emisor
        - id_receptor
        - id_plantilla
        - channel_ids
      properties:
        id_emisor:
          type: string
          description: Nombre del servicio emisor
          example: "orders-service"
        id_receptor:
          type: string
          description: UUID del usuario receptor
          example: "user-uuid-123"
        id_plantilla:
          type: integer
          description: ID de la plantilla a usar
          example: 1
        channel_ids:
          type: array
          items:
            type: integer
          description: IDs de los canales por los que enviar
          example: [1, 3]

    TestEmailRequest:
      type: object
      required:
        - to
      properties:
        to:
          type: string
          format: email
          description: Email del destinatario
          example: "test@example.com"
        subject:
          type: string
          description: Asunto del email
          example: "Email de Prueba"
        content:
          type: string
          description: Contenido HTML del email
          example: "<h1>Este es un email de prueba</h1>"

    # ===== RESPONSE SCHEMAS =====
    NotificationResponse:
      type: object
      properties:
        id_notificacion:
          type: integer
          description: ID √∫nico de la notificaci√≥n
          example: 45
        fecha_hora:
          type: string
          format: date-time
          description: Fecha y hora de creaci√≥n
          example: "2025-11-05T01:30:00.000Z"
        id_emisor:
          oneOf:
            - type: integer
            - type: string
          description: ID del emisor (n√∫mero o string)
          example: 1
        id_receptor:
          oneOf:
            - type: integer
            - type: string
          description: ID del receptor (n√∫mero o string)
          example: 123
        id_plantilla:
          type: integer
          description: ID de la plantilla utilizada
          example: 1
        channel_ids:
          type: array
          items:
            type: integer
          description: Canales utilizados
          example: [1, 3]
        estado:
          type: string
          enum: [pendiente, enviado, recibido, leido, fallido]
          description: Estado actual de la notificaci√≥n
          example: "pendiente"

    UserNotificationsResponse:
      type: object
      properties:
        notifications:
          type: array
          items:
            $ref: '#/components/schemas/NotificationResponse'
        pagination:
          type: object
          properties:
            currentPage:
              type: integer
              example: 1
            totalPages:
              type: integer
              example: 3
            totalItems:
              type: integer
              example: 25
            itemsPerPage:
              type: integer
              example: 10

    UserHistoryResponse:
      type: object
      properties:
        notifications:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/NotificationResponse'
              - type: object
                properties:
                  channels_used:
                    type: array
                    items:
                      type: string
                    example: ["email", "push"]
        meta:
          type: object
          properties:
            total:
              type: integer
              example: 50
            page:
              type: integer
              example: 1
            limit:
              type: integer
              example: 15
            hasNextPage:
              type: boolean
              example: true

    StatsResponse:
      type: object
      properties:
        total:
          type: integer
          description: Total de notificaciones
          example: 150
        pendientes:
          type: integer
          description: Notificaciones pendientes
          example: 12
        enviados:
          type: integer
          description: Notificaciones enviadas
          example: 85
        recibidos:
          type: integer
          description: Notificaciones recibidas
          example: 35
        leidos:
          type: integer
          description: Notificaciones le√≠das
          example: 15
        fallidos:
          type: integer
          description: Notificaciones fallidas
          example: 3
        byStatus:
          type: object
          properties:
            pendiente:
              type: integer
              example: 12
            enviado:
              type: integer
              example: 85
            recibido:
              type: integer
              example: 35
            leido:
              type: integer
              example: 15
            fallido:
              type: integer
              example: 3
        byChannel:
          type: object
          properties:
            email:
              type: integer
              example: 120
            sms:
              type: integer
              example: 15
            push:
              type: integer
              example: 90
        timestamp:
          type: string
          format: date-time
          example: "2025-11-05T01:30:00.000Z"

    HistoryStatsResponse:
      type: object
      properties:
        totalNotifications:
          type: integer
          example: 150
        statusDistribution:
          type: object
          properties:
            pendiente:
              type: integer
              example: 12
            enviado:
              type: integer
              example: 85
            recibido:
              type: integer
              example: 35
            leido:
              type: integer
              example: 15
            fallido:
              type: integer
              example: 3
        channelUsage:
          type: object
          properties:
            email:
              type: integer
              example: 120
            sms:
              type: integer
              example: 15
            push:
              type: integer
              example: 90
        templateUsage:
          type: object
          additionalProperties:
            type: integer
          example:
            "1": 45
            "2": 30
            "5": 25

    ListenerStatusResponse:
      type: object
      properties:
        changeStreams:
          type: object
          properties:
            ordersStreamActive:
              type: boolean
              description: Estado del listener de √≥rdenes
              example: true
            paymentsStreamActive:
              type: boolean
              description: Estado del listener de pagos
              example: true
            connected:
              type: boolean
              description: Estado de conexi√≥n general
              example: true
            timestamp:
              type: string
              format: date-time
              example: "2025-11-05T01:30:00.000Z"
        notifications:
          $ref: '#/components/schemas/StatsResponse'
        integration:
          type: object
          properties:
            active:
              type: boolean
              description: Estado de la integraci√≥n
              example: true
            message:
              type: string
              description: Mensaje descriptivo del estado
              example: "üéß Escuchando eventos en tiempo real"

    HealthResponse:
      type: object
      properties:
        service:
          type: string
          example: "email"
        status:
          type: string
          enum: [healthy, unhealthy]
          example: "healthy"
        timestamp:
          type: string
          format: date-time
          example: "2025-11-05T01:30:00.000Z"

    TestEmailResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Test email sent successfully"

    # ===== CONFIGURATION SCHEMAS =====
    Template:
      type: object
      properties:
        id_Plantilla:
          type: integer
          description: ID √∫nico de la plantilla
          example: 1
        tipo_Plantilla:
          type: integer
          description: ID del tipo de plantilla
          example: 1
        asunto_base:
          type: string
          description: Asunto base de la notificaci√≥n
          example: "Tu orden fue creada"
        descripci√≥n_base:
          type: string
          description: Contenido base de la notificaci√≥n
          example: "Tu orden {numero_orden} por ${monto} ha sido creada exitosamente"

    Channel:
      type: object
      properties:
        id_canal:
          type: integer
          description: ID √∫nico del canal
          example: 1
        tipo_canal:
          type: string
          description: Tipo de canal
          example: "email"
        nombre_canal:
          type: string
          description: Nombre descriptivo del canal
          example: "Correo Electr√≥nico"
        activo:
          type: boolean
          description: Estado del canal
          example: true

    TemplateType:
      type: object
      properties:
        id_tipo_plantilla:
          type: integer
          description: ID √∫nico del tipo
          example: 1
        nombre_tipo:
          type: string
          description: Nombre del tipo
          example: "order_created"
        descripcion:
          type: string
          description: Descripci√≥n del tipo
          example: "Plantilla para orden creada"

    # ===== ERROR SCHEMAS =====
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Mensaje de error
          example: "Validation failed"
        message:
          type: string
          description: Descripci√≥n detallada
          example: "id_plantilla is required"
        statusCode:
          type: integer
          description: C√≥digo de estado HTTP
          example: 400

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT para autenticaci√≥n

# Global security (opcional)
security:
  - BearerAuth: []

tags:
  - name: "üì® Gesti√≥n de Notificaciones"
    description: "Endpoints para crear y gestionar notificaciones"
  - name: "üë§ Consultas por Usuario" 
    description: "Endpoints para consultar notificaciones de usuarios espec√≠ficos"
  - name: "üìä Estad√≠sticas"
    description: "Endpoints para obtener m√©tricas y estad√≠sticas del sistema"
  - name: "‚öôÔ∏è Configuraci√≥n"
    description: "Endpoints para obtener configuraci√≥n de plantillas y canales"
  - name: "üéß Monitoreo"
    description: "Endpoints para monitorear el estado del sistema Change Streams"
  - name: "üîß Testing"
    description: "Endpoints para testing y verificaci√≥n de servicios"