version: '3.9'

services:

  # -----------------------------
  # NGINX — Gateway + Servidor del Frontend
  # -----------------------------
  nginx:
    image: nginx:alpine
    container_name: notif-nginx
    ports:
      - "4508:80"   # Host 4508 → Nginx 80
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./FrontendNotificacionesTITEC/dist:/usr/share/nginx/html:ro
    depends_on:
      - backend
      - frontend

  # -----------------------------
  # FRONTEND — React compilado (sirve Nginx)
  # -----------------------------
  frontend:
    build: ./FrontendNotificacionesTITEC
    container_name: notif-frontend
    # NO expone puertos porque lo sirve nginx
    # NO usa 5173

  # -----------------------------
  # BACKEND — Nest.js
  # -----------------------------
  backend:
    build: ./BackendNotificacionesTITEC
    container_name: notif-backend
    ports:
      - "4500:3000"   # Host 4500 → Backend 3000
    environment:
      - NODE_ENV=production
      - PORT=3000
      - MONGODB_URI=mongodb://mongo:27017/notificaciones
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_CLIENT_ID=notifications-service
      - KAFKA_GROUP_ID=notifications-group
      - KAFKA_CONNECTION_TIMEOUT=3000
      - KAFKA_REQUEST_TIMEOUT=30000
      - KAFKA_INITIAL_RETRY_TIME=100
      - KAFKA_RETRIES=8
      - KAFKA_TOPIC_ORDERS_CREATED=orders.created
      - KAFKA_TOPIC_ORDERS_STATUS=orders.status_changed
      - KAFKA_TOPIC_PAYMENTS_CONFIRMED=payments.confirmed
      - KAFKA_TOPIC_PAYMENTS_REJECTED=payments.rejected
      - KAFKA_TOPIC_PAYMENTS_ISSUES=payments.issues
      - KAFKA_TOPIC_MESSAGES_RECEIVED=messages.received
      - KAFKA_TOPIC_PRODUCTS_EDITED=products.edited
      - KAFKA_TOPIC_SHIPPING=orders.shipped
      - DEFAULT_NOTIFICATION_CHANNELS=1,2
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=465
      - SMTP_SECURE=true
      - SMTP_USER=mailernoti@gmail.com
      - SMTP_PASS=vyubbfqbgsokuyus
      - SMTP_FROM=mailernoti@gmail.com
    depends_on:
      - mongo
      - kafka

  # -----------------------------
  # MONGO DB
  # -----------------------------
  mongo:
    image: mongo:6
    container_name: notif-mongo
    ports:
      - "5173:27017"  # Host 5173 → Mongo interno 27017
    volumes:
      - mongo-data:/data/db

  # -----------------------------
  # ZOOKEEPER
  # -----------------------------
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: notif-zookeeper
    ports:
      - "4507:2181"  # Host 4507 → Zookeeper interno
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  # -----------------------------
  # KAFKA
  # -----------------------------
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: notif-kafka
    depends_on:
      - zookeeper
    ports:
      - "4506:9092"  # Host 4506 → Kafka interno 9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'

volumes:
  mongo-data: