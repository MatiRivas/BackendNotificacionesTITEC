openapi: 3.0.3
info:
  title: TITEC - Sistema de Notificaciones API
  description: |
    **API del Microservicio de Notificaciones para TITEC - Versi√≥n Final**
    
    Sistema completo de notificaciones con integraci√≥n Kafka para comunicaci√≥n entre microservicios.
    
    ## üéØ Caracter√≠sticas principales:
    
    - ‚úÖ **14 plantillas de notificaci√≥n** (7 para compradores, 7 para vendedores)
    - ‚úÖ **M√∫ltiples canales**: Email, Push Notifications
    - ‚úÖ **Integraci√≥n con Kafka**: Consume eventos de √≥rdenes, pagos, mensajes y productos
    - ‚úÖ **Estados progresivos**: pendiente ‚Üí enviado ‚Üí recibido ‚Üí le√≠do
    - ‚úÖ **Metadata din√°mica**: Personalizaci√≥n basada en variables de contexto
    - ‚úÖ **Gesti√≥n de lectura**: Marcar notificaciones como le√≠das individual
    - ‚úÖ **Estad√≠sticas**: Tracking de notificaciones por usuario, tipo y estado
    
    ## üìã Plantillas disponibles:
    
    ### Comprador (Plantillas 1-7):
    1. Nueva venta realizada
    2. Compra confirmada
    3. Estado de pedido cambiado
    4. Pedido enviado
    5. Pedido cancelado
    6. Problema de pago
    7. Pago confirmado
    8. Pago rechazado
    
    ### Vendedor (Plantillas 8-14):
    9. Pago recibido
    10. Venta cancelada por vendedor
    11. Compra cancelada por comprador
    12. Pedido listo para despacho
    13. Nuevo mensaje recibido
    14. Producto editado
    
    ## üîå Integraci√≥n Kafka:
    
    El sistema consume autom√°ticamente eventos de los siguientes topics:
    - `orders.created` - Nueva orden creada
    - `orders.status_changed` - Cambio de estado de orden
    - `orders.shipped` - Orden enviada
    - `payments.confirmed` - Pago confirmado
    - `payments.rejected` - Pago rechazado
    - `payments.issues` - Problema con pago
    - `messages.received` - Nuevo mensaje recibido
    - `products.edited` - Producto editado
    
  version: 1.0.0
  contact:
    name: Equipo TITEC
    email: equipo@titec.cl
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api/notifications
    description: Servidor de desarrollo local


tags:
  - name: "üì® Gesti√≥n de Notificaciones"
    description: Operaciones CRUD de notificaciones
  - name: "üë§ Notificaciones de Usuario"
    description: Consultas espec√≠ficas por usuario
  - name: "üìä Estad√≠sticas"
    description: M√©tricas y analytics de notificaciones
  - name: "‚öôÔ∏è Configuraci√≥n"
    description: Plantillas, canales y tipos
  - name: "üß™ Testing"
    description: Endpoints para pruebas y diagn√≥stico

paths:
  # ===== GESTI√ìN DE NOTIFICACIONES =====
  
  /create:
    post:
      tags:
        - "üì® Gesti√≥n de Notificaciones"
      summary: Crear nueva notificaci√≥n
      description: |
        Crea una notificaci√≥n manualmente con los par√°metros especificados.
        
        **Nota**: En producci√≥n, las notificaciones se crean autom√°ticamente 
        a trav√©s de eventos Kafka. Este endpoint es √∫til para testing.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id_emisor
                - id_receptor
                - id_plantilla
                - channel_ids
              properties:
                id_emisor:
                  type: string
                  description: ID del usuario que genera la notificaci√≥n
                  example: "seller-uuid-123"
                id_receptor:
                  type: string
                  description: ID del usuario que recibe la notificaci√≥n
                  example: "buyer-uuid-456"
                id_plantilla:
                  type: integer
                  description: ID de la plantilla a utilizar (1-14)
                  minimum: 1
                  maximum: 14
                  example: 1
                channel_ids:
                  type: array
                  description: IDs de los canales por los que enviar (1=Email, 2=SMS, 3=Push, 4=Interna)
                  items:
                    type: integer
                    enum: [1, 2, 3, 4]
                  example: [1, 3]
      responses:
        '201':
          description: Notificaci√≥n creada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  id_notificacion:
                    type: string
                    example: "674a5b8f9c1d2e3f4a5b6c7d"
                  estado:
                    type: string
                    example: "pendiente"
                  message:
                    type: string
                    example: "Notificaci√≥n creada exitosamente"
        '400':
          description: Datos inv√°lidos
        '500':
          description: Error del servidor

  # ===== NOTIFICACIONES DE USUARIO =====
  
  /user/{userId}:
    get:
      tags:
        - "üë§ Notificaciones de Usuario"
      summary: Obtener notificaciones de un usuario
      description: |
        Obtiene todas las notificaciones de un usuario espec√≠fico con paginaci√≥n.
        
        Las notificaciones se devuelven procesadas con:
        - T√≠tulo y mensaje con variables reemplazadas
        - Metadata completa y normalizada
        - Informaci√≥n de canales utilizados
        - Estado actual de la notificaci√≥n
      parameters:
        - name: userId
          in: path
          required: true
          description: ID del usuario (puede ser string UUID o n√∫mero)
          schema:
            type: string
          example: "buyer-test-123"
        - name: page
          in: query
          description: N√∫mero de p√°gina (comienza en 1)
          schema:
            type: integer
            default: 1
            minimum: 1
          example: 1
        - name: limit
          in: query
          description: Cantidad de notificaciones por p√°gina
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          example: 20
      responses:
        '200':
          description: Lista de notificaciones del usuario
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProcessedNotification'
        '404':
          description: Usuario no encontrado
        '500':
          description: Error del servidor

  /notificacion_leida/{notificationId}:
    post:
      tags:
        - "üë§ Notificaciones de Usuario"
      summary: Marcar notificaci√≥n como le√≠da
      description: Marca una notificaci√≥n individual como le√≠da
      parameters:
        - name: notificationId
          in: path
          required: true
          description: ID de la notificaci√≥n
          schema:
            type: string
          example: "674a5b8f9c1d2e3f4a5b6c7d"
      responses:
        '200':
          description: Notificaci√≥n marcada como le√≠da
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Notificaci√≥n marcada como le√≠da"
                  notificationId:
                    type: string
                    example: "674a5b8f9c1d2e3f4a5b6c7d"
        '404':
          description: Notificaci√≥n no encontrada
        '500':
          description: Error del servidor

  # ===== ESTAD√çSTICAS =====
  
  /stats:
    get:
      tags:
        - "üìä Estad√≠sticas"
      summary: Estad√≠sticas b√°sicas del sistema
      description: |
        Obtiene estad√≠sticas generales del sistema de notificaciones:
        - Total de notificaciones
        - Distribuci√≥n por estado
        - Notificaciones por plantilla
        - Notificaciones por canal
      responses:
        '200':
          description: Estad√≠sticas del sistema
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    example: 1250
                  byStatus:
                    type: object
                    properties:
                      pendiente:
                        type: integer
                        example: 45
                      enviado:
                        type: integer
                        example: 890
                      leido:
                        type: integer
                        example: 315
                  byTemplate:
                    type: object
                    example:
                      "1": 150
                      "2": 148
                      "3": 95
                  byChannel:
                    type: object
                    properties:
                      email:
                        type: integer
                        example: 1100
                      push:
                        type: integer
                        example: 980

  # ===== CONFIGURACI√ìN =====
  
  /templates:
    get:
      tags:
        - "‚öôÔ∏è Configuraci√≥n"
      summary: Listar todas las plantillas
      description: |
        Obtiene la lista completa de plantillas de notificaci√≥n disponibles.
        
        Incluye:
        - ID de plantilla
        - Descripci√≥n base
        - Asunto base
        - Tipo de plantilla
        - Rol asociado (buyer/seller)
      responses:
        '200':
          description: Lista de plantillas
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id_Plantilla:
                      type: integer
                      example: 1
                    descripci√≥n_base:
                      type: string
                      example: "Tienes una nueva venta de {{productName}} por {{amount}}{{currency}}"
                    asunto_base:
                      type: string
                      example: "¬°Nueva venta realizada!"
                    tipo_plantilla:
                      type: integer
                      example: 1
                    rol:
                      type: string
                      enum: [buyer, seller]
                      example: "seller"

  /channels:
    get:
      tags:
        - "‚öôÔ∏è Configuraci√≥n"
      summary: Listar canales de notificaci√≥n
      description: |
        Obtiene la lista de canales disponibles:
        1. Email
        2. SMS
        3. Push Notification
        4. Notificaci√≥n interna
      responses:
        '200':
          description: Lista de canales
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id_canal:
                      type: integer
                      example: 1
                    descripci√≥n:
                      type: string
                      example: "Email"
                    activo:
                      type: boolean
                      example: true

  /template-types:
    get:
      tags:
        - "‚öôÔ∏è Configuraci√≥n"
      summary: Listar tipos de plantilla
      description: |
        Obtiene la lista de tipos de plantilla:
        - order_confirmation
        - payment_status
        - shipping_update
        - order_canceled
        - new_message
        - product_update
      responses:
        '200':
          description: Lista de tipos
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id_tipo:
                      type: integer
                    tipo:
                      type: string
                    descripci√≥n:
                      type: string

  # ===== TESTING Y DIAGN√ìSTICO =====
  
  /listener-status:
    get:
      tags:
        - "üß™ Testing"
      summary: Estado de integraci√≥n Kafka
      description: |
        Verifica el estado de la integraci√≥n con Kafka:
        - Conexi√≥n activa
        - Eventos procesados
        - Consumers activos
      responses:
        '200':
          description: Estado de listeners
          content:
            application/json:
              schema:
                type: object
                properties:
                  changeStreams:
                    type: object
                    properties:
                      connected:
                        type: boolean
                        example: true
                      ordersStreamActive:
                        type: boolean
                        example: true
                      paymentsStreamActive:
                        type: boolean
                        example: true
                  notifications:
                    type: object
                  integration:
                    type: object
                    properties:
                      active:
                        type: boolean
                        example: true
                      message:
                        type: string
                        example: "üéß Escuchando eventos en tiempo real"

  /health/email:
    get:
      tags:
        - "üß™ Testing"
      summary: Verificar salud del servicio de email
      description: Prueba la conexi√≥n con el servidor SMTP
      responses:
        '200':
          description: Estado del servicio de email
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: "email"
                  status:
                    type: string
                    enum: [healthy, unhealthy]
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time

  /test/email:
    post:
      tags:
        - "üß™ Testing"
      summary: Enviar email de prueba
      description: Env√≠a un email de prueba para verificar configuraci√≥n SMTP
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - to
              properties:
                to:
                  type: string
                  format: email
                  example: "test@example.com"
                subject:
                  type: string
                  example: "Test Email"
                content:
                  type: string
                  example: "<h1>This is a test</h1>"
      responses:
        '200':
          description: Email enviado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /retry-failed:
    post:
      tags:
        - "üß™ Testing"
      summary: Reintentar notificaciones fallidas
      description: Reintenta el env√≠o de notificaciones que fallaron anteriormente
      responses:
        '200':
          description: Reintento iniciado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Failed notifications retry initiated"

components:
  schemas:
    ProcessedNotification:
      type: object
      properties:
        id_notificacion:
          type: string
          description: ID √∫nico de la notificaci√≥n
          example: "674a5b8f9c1d2e3f4a5b6c7d"
        id_emisor:
          type: string
          description: ID del usuario emisor
          example: "seller-uuid-456"
        id_receptor:
          type: string
          description: ID del usuario receptor
          example: "buyer-uuid-123"
        id_plantilla:
          type: integer
          description: ID de la plantilla utilizada
          example: 1
        title:
          type: string
          description: T√≠tulo procesado de la notificaci√≥n
          example: "¬°Nueva venta realizada!"
        message:
          type: string
          description: Mensaje procesado con variables reemplazadas
          example: "Tienes una nueva venta de Laptop Dell por $45,990 CLP"
        type:
          type: string
          description: Tipo de notificaci√≥n
          enum:
            - order_confirmation
            - payment_status
            - shipping_update
            - order_canceled
            - new_message
            - product_update
          example: "order_confirmation"
        estado:
          type: string
          description: Estado actual de la notificaci√≥n
          enum: [pendiente, enviado, recibido, leido, fallido]
          example: "enviado"
        leido:
          type: boolean
          description: Si fue le√≠da por el usuario
          example: false
        fecha_creacion:
          type: string
          format: date-time
          example: "2025-11-29T10:30:00.000Z"
        fecha_envio:
          type: string
          format: date-time
          example: "2025-11-29T10:30:05.000Z"
        metadata:
          type: object
          description: Datos contextuales de la notificaci√≥n
          properties:
            orderId:
              type: string
              example: "ORD-1001"
            amount:
              type: number
              example: 45990
            currency:
              type: string
              example: "CLP"
            productName:
              type: string
              example: "Laptop Dell"
            buyerName:
              type: string
              example: "Juan P√©rez"
            sellerName:
              type: string
              example: "Tienda Tech"
            actionUrl:
              type: string
              example: "/orders/ORD-1001"
        channels:
          type: array
          description: Canales por los que se envi√≥
          items:
            type: object
            properties:
              id_canal:
                type: integer
                example: 1
              descripci√≥n:
                type: string
                example: "Email"
              estado:
                type: string
                example: "enviado"

# ===== END OF FILE =====